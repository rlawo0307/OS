[ORG 0x00]
[BITS 16]

SECTION .text
;kch stack test
; jmp 0x1000:START    ;??로더 2? ?? ??? 바꿔?
jmp 0x07E0:START
TOTALSECTORCOUNT: dw 0x02	;??로더 ??? MINT64 OS ?미?? ??

KERNEL32SECTORCOUNT: dw 0x02

START:
;TODO : Check(kch)
    mov ax, cs
    mov ds, ax
    mov ax, 0xB800
    mov es, ax

    mov si, 0
    mov di, 0

	;TODO: ??? 빼야?? ?(kch)
	push MESSAGE1	; 출력? 메세?? ????? ??? ??
	push 0	;?? Y좌표(0)? ??? ??
	push 0	;?? X좌표(0)? ??? ??
	call PRINTMESSAGE	;PRINTMESSAGE ?? ??
	add sp, 6	;??? ??미터 ??

	push MESSAGEDAY	;출력? 메세? - ??/?? ? ????? ??? ??
	push 1	;?? Y좌표(1)? ??? ??
	push 0	;?? X좌표(0)? ??? ??
	call PRINTMESSAGE	;PRINTMESSAGE ?? ??
	add sp, 6	;??? ??미터 ??

	push IMAGELOADINGMESSAGE	; 출력? 메세?? ????? ??? ??
	push 2	;?? Y좌표(2)? ??? ??
	push 0	;?? X좌표(0)? ??? ??
	call PRINTMESSAGE	;PRINTMESSAGE ?? ??
	add sp, 6	;??? ??미터 ??

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; 	????? OS ?미??? 로딩
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;

; 	???? ?? ?? 먼?? 리셋
RESETDISK:			; ???? 리셋?? 코드? ??

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; 	BIOS Reset Function ??
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
	; ?비스 번호 0, ???? 번호 (0=Floppy)
	mov ax, 0
	mov dl, 0
	int 0x13
	; ??? 발생?? ?? 처리? ?? 
	jc HANDLEDISKERROR
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; 	????? ??? ??
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
;kch stack test
	; mov si, 0x1020	; OS ?미??? 복사? ????(????? 바꿨?)
    mov si, 0x1000
	mov es, si		;ES ?그먼? ????? ? ??
	mov bx, 0x0000	;BX ????? 0x0000? ???? 복사?

	mov di, word[ TOTALSECTORCOUNT ]	;복사? OS ?미??? ?? ?? DI ????? ??

READDATA:			; 모든 ??? ? ???? ??
	cmp di, 0		; 복사? OS ?미??? ?? ?? 0? 비교
	je READEND		; 복사? ?? ?? 0??? ? 복사 ? ? ??? READEND? ??
	sub di, 0x1		; 복사? ?? ?? 1 감소??
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; 	BIOS Read Function ??
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
	mov ah, 0x02         ; BIOS ?비스 번호 2 - Read Sector        
    mov al, 0x1          ; ?? ?? ?? 1
	mov ch, byte[ TRACKNUMBER ]			; ?? ?? 번호 ??
	mov cl, byte[ SECTORNUMBER ]		; ?? ?? 번호 ??
	mov dh, byte[ HEADNUMBER ]			; ?? ?? 번호 ??
	mov dl, 0x00                  		; ?? ???? 번호 (0=Floppy) ??
    int 0x13                        	; ???? ?비스 ?? 
										; (0x13 : ?? 기반 ??/?로피 ??? ?기·쓰? ?비스 ??)
	jc HANDLEDISKERROR					; ??? 발생??? ??? 출력?? 곳으? ?? 

;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; 	복사? ??????? ??, ??, ?? ???? 계산 
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    add si, 0x0020      ; 512(0x200)바이? 만큼 ????? ?? ?그먼? ???? 값으? ??
    mov es, si          ; ES ?그먼? ????? ??? ????? ? ??만큼 증??

    ; 마??? ??? ??? ?? ?기로 ???? ?? ?? ?? ??


	mov al, byte [ SECTORNUMBER ]   ; ?? 번호? AL????? ??
    add al, 0x01                    ; ?? 번호? 1 증??
    mov byte [ SECTORNUMBER ], al   ; 증???? ?? 번호? SECTORNUMBER? ?? ??
    cmp al, 19                      ; 증???? ?? 번호? 19??? 비교
    jl READDATA                     ; ?? 번호? 19미만??? READDATA? ??

	; 마??? ??까?? ???? ??? ????, ?? 번호? 1? ??
    xor byte [ HEADNUMBER ], 0x01   ; ?? 번호? 0x01? XOR?? ??
    mov byte [ SECTORNUMBER ], 0x01 ; ?? 번호? 1 ? ??

    ; 만약 ??? 1->0?? 바?었?? ?? ??? 모두 ????것이?? ??? ???? ?? 번호? 1 증??
    cmp byte [ HEADNUMBER ], 0x00   ; ?? 번호? 0x00? 비교
    jne READDATA                    ; ?? 번호? 0? ??? READDATA? ??

    ; ??? 1 증???? ?, ?? ?? ?기로 ??
    add byte [ TRACKNUMBER ] , 0x01 ; ?? 번호? 1 증??
    jmp READDATA                    ; READDATA? ??

READEND:
    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    ; OS ?미??? ?료되??? 메시?? 출력
    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
	push LOADINGCOMPLETEMESSAGE	; 출력? 메시?? ????? ??? ??
	push 2						; ?? Y 좌표 1? ??? ??
	push 20						; ?? X 좌표 20? ??? ??
	call PRINTMESSAGE			; PRINTMESSAGE ?? ??
	add sp, 6					; ??? ??미터 ??

    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    ; ?? OS ?미?? ?? (VirtualOS))
    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    ;kch stack test
	; jmp 0x1020:0x0000
    jmp 0x1000:0x0000
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; ?? 코드 ??
;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
; ??? ??? 처리?? ??
HANDLEDISKERROR:
    push DISKERRORMESSAGE   ; ?? 문자?? ????? ??? ??
    push 2                  ; ?? Y 좌표 1? ??? ??
    push 20                 ; ?? X 좌표 20? ??? ??
    call PRINTMESSAGE       ; PRINTMESSAGE ?? ??
    add sp, 6               ; ??? ??미터 ??

	jmp $					; ?? ?치에? 무한 루프 ??
; 메시?? 출력?? ?? - PARAM: x좌표, y좌표, 문자?
PRINTMESSAGE:
    push bp     ; 베이? ??? ????(BP)? ??? ??
    mov bp, sp  ; 베이? ??? ????(BP)? ?? ??? ????(SP)? 값을 ??
    push es     ; ES ?그먼? ?????? DX ????까?? ??? ??
	push si
	push di
	push ax
	push cx
	
    mov ax, 0xB800          ; 비디? 메모? ?? ????(0xB8000)? ?그먼? ???? 값으? ??
    mov es, ax              ; ES ?그먼? ????? ??
	;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    ; X, Y? 좌표? 비디? 메모리의 ????? 계산?
    ;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;
    ; Y 좌표? ???? 먼?? ?? ????? 구함
	mov ax, word [ bp + 6 ] ; ??미터 2(Y좌표)? AX ????? ??
    mov si, 160             ; ? ??? 바이? ?(2 * 80 컬럼)? SI ????? ??
    mul si                  ; AX ??????? SI ????? 곱하? ?? Y???? 계산
    mov di, ax              ; 계산? ?? Y ????? DI ????? ??

    ; X 좌표? ???? 2? 곱한 ? 최종 ????? 구함
    mov ax, word [ bp + 4 ] ; ??미터 1(X좌표)? AX ????? ??
    mov si, 2               ; ? 문자? ?????? 바이??(2)? SI ????? ??
    mul si                  ; AX ??????? SI ????? 곱하? ?? X ????? 계산
    add di, ax              ; ?? Y ??????? 계산? X ????? ??? ?? 비디? 메모? ????? 계산

    mov si, word [ bp + 8 ] ; ??미터 3(출력? 문자?? ????)

.MESSAGELOOP:               ; 메시?? 출력?? 루프
    mov cl, byte [ si ]     ; SI ????? ?리키? 문자? ?치에? ? 문자? CL ????? 복사
                            ; 문자???? 1바이?? 충분??? CX ????? ?? 1바이?? ??

    cmp cl, 0               ; 복사? 문자??? 0? 비교
    je  .MESSAGEEND         ; 복사? 문자? 값이 0?? .MESSAGEEND? ???? 문자 출력 종료


    mov byte [ es: di ], cl ; 0? ???? 메모? ???? 비디? 메모? ????? 문자? 출력

    add si, 1               ; SI ????? 1? ??? ?? 문자?? ??
    add di, 2               ; DI ????? 2? ??? 비디? 메모리의 ?? 문자 ?치로 ?? 문자? 출력??? 2? ????

    jmp .MESSAGELOOP        ; 메시? 출력 루프? ???? ?? 문자? 출력

.MESSAGEEND:
	pop cx
	pop ax
	pop di
	pop si
	pop es
	pop bp
	ret

;??? ?? ------------------------------------------
MESSAGE1:    db 'MINT64 OS Boot Loader Start~!!', 0 	;출력? 메시? ?? -> 마??막?? 0?? ???? .MESSAGELOOP ?? 처리? ? ?? ? 


DISKERRORMESSAGE:       db  'DISK Error~!!', 0
IMAGELOADINGMESSAGE:    db  'OS Image Loading...', 0
LOADINGCOMPLETEMESSAGE: db  'Complete~!!', 0

MESSAGEDAY:					db 'Current Date:' , 0

SECTORNUMBER:				db 0x03	;??로더 2개로 ?? ??? ??
HEADNUMBER: 				db 0x00
TRACKNUMBER: 				db 0x00

times 510 - ( $ - $$ )    db    0x00	;???? 510 address 까?? 1바이?? ??
                                		; ?? ?치에? 510 address 까?? 반복???? 0x00?? 채??

db 0x55 
db 0xAA ; 마??? 바이? 값이 0xAA?? ?? 
    ;?? ?? 512 바이??? 마??? 2바이?? 0x55? 0xAA? ???? ??로더? ?? ?? ?? 
